"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./feature-54323509.js"),t=require("./browser-ef557d00.js"),r=require("./promotionPopup.js"),o=require("./promotionCard.js"),i=require("./promotionSideCard.js");require("axios"),require("date-fns"),require("mapbox-gl");const s="#373737",a="#6e523c",n="#000000",d="#f1f1f1",l="#373737",h="#f1f1f1",m="#000000",c="#6e523c",p={"icon-image":["get","icon"],"icon-size":["interpolate",["exponential",1.5],["zoom"],10,.5,16,1],"text-field":["get","name_ja"],"text-anchor":"top","text-size":["interpolate",["exponential",1.5],["zoom"],10,9,16,12]},u={"text-color":a,"text-halo-color":d,"text-halo-width":1,"icon-halo-color":a,"icon-halo-width":1.5,"text-translate":["interpolate",["exponential",1.5],["zoom"],10,["literal",[0,12]],16,["literal",[0,24]]],"text-translate-anchor":"viewport","text-opacity":["step",["zoom"],0,14,1]},_=["all",[">=",["zoom"],["get","min_zoom"]]];require("./shim"),require("./modules/core.dict"),require("./modules/core.get-iterator-method"),require("./modules/core.get-iterator"),require("./modules/core.is-iterable"),require("./modules/core.delay"),require("./modules/core.function.part"),require("./modules/core.object.is-object"),require("./modules/core.object.classof"),require("./modules/core.object.define"),require("./modules/core.object.make"),require("./modules/core.number.iterator"),require("./modules/core.regexp.escape"),require("./modules/core.string.escape-html"),require("./modules/core.string.unescape-html"),module.exports=require("./modules/_core");class g{_map;_source;_layer;_layerId="promotion-symbols";_sourceId="promotions-source";_isDarkMode;_enablePromotionCard;_enablePromotionSideCard;_promotionCard;_promotionPopup;_promotionSideCard;_listeners={};_renderedFeaturesAdids=[];constructor(e,r,o={}){this.accessToken=r;const{baseUrl:i,sourceUrl:s,telemetryUrl:a,mobileMaxWidth:n,enablePromotionCard:d,enablePromotionSideCard:l,isDarkMode:h,debug:m}=o;i&&(this.baseUrl=i),s&&(this.sourceUrl=s),a&&(this.telemetryUrl=a),m&&(this.debug=m),n&&(this.mobileMaxWidth=n),this._map=e,this._source={type:"vector",url:this.sourceUrl},this._layer={id:this._layerId,type:"symbol",source:this._sourceId,"source-layer":this.layerSourceId,layout:p,paint:u,filter:_},this._enablePromotionCard=d||!1,this._enablePromotionSideCard=l||!1,this._isDarkMode=h||!1,this._map.on("load",this.load.bind(this)),this._map.on("render",this.render.bind(this)),this._map.on("move",this.move.bind(this)),this._map.on("styleimagemissing",this.styleImageMissing.bind(this)),this._map.on("click",this._layerId,this.click.bind(this)),this._map.on("idle",this.idle.bind(this)),t.insertElementEndpoint("mapboxgl-global-style"),window.addEventListener("load",(()=>this.activate())),"complete"===document.readyState&&this.activate()}get accessToken(){return e.config.ACCESS_TOKEN}set accessToken(t){e.config.ACCESS_TOKEN=t}get baseUrl(){return e.config.BASE_URL}set baseUrl(t){e.config.BASE_URL=t}get sourceUrl(){return e.config.SOURCE_URL}set sourceUrl(t){e.config.SOURCE_URL=t}get telemetryUrl(){return e.config.TELEMETRY_URL}set telemetryUrl(t){e.config.TELEMETRY_URL=t}get debug(){return e.config.DEBUG}set debug(t){e.config.DEBUG=t}get layerSourceId(){return e.config.LAYER_SOURCE_ID}set layerSourceId(t){e.config.LAYER_SOURCE_ID=t}get mobileMaxWidth(){return e.config.MOBILE_MAX_WIDTH}set mobileMaxWidth(t){e.config.MOBILE_MAX_WIDTH=t}get isDarkMode(){return this._isDarkMode}set isDarkMode(e){this._isDarkMode=e}get map(){return this._map}get layer(){return this._map.getLayer(this._layerId)}get enablePromotionPopup(){return!this._enablePromotionCard&&!this._enablePromotionSideCard}set enablePromotionPopup(e){e?(this._enablePromotionCard=!1,this._enablePromotionSideCard=!1):(this._enablePromotionCard=!0,this._enablePromotionSideCard=!1)}get enablePromotionCard(){return this._enablePromotionCard}set enablePromotionCard(e){this._enablePromotionCard=e,this._enablePromotionSideCard=!1}get enablePromotionSideCard(){return this._enablePromotionSideCard}set enablePromotionSideCard(e){this._enablePromotionCard=!1,this._enablePromotionSideCard=e}activate(){window.renderApp&&window.renderApp(e.config),e.sessionStart()}reloadPromotionLalyer(){this._map.getSource(this._sourceId)&&this._map.removeSource(this._sourceId),this._map.getLayer(this._layerId)&&this._map.removeLayer(this._layerId),this._map.addSource(this._sourceId,this._source),this._map.addLayer(this._layer)}load(t){this.fire(new e.Event(e.EVENT_TYPES.LOAD,{map:t.target})),this.reloadPromotionLalyer()}render(e){this.updateRenderedFeatures()}move(t){const r=this.map.queryRenderedFeatures(void 0,{layers:[this._layerId]}),o=[];for(const e of r)e.properties&&e.properties.adid&&o.push(e);this.fire(new e.Event(e.EVENT_TYPES.MOVE,{map:t.target,originalEvent:t.originalEvent,features:o}))}async show(e){if(this._enablePromotionSideCard){if(!this._promotionSideCard)throw new Error("It needs to be added PromotionSideCard handler.");this._promotionSideCard.show(e)}else if(this._enablePromotionCard){if(!this._promotionCard)throw new Error("It needs to be added PromotionCard handler.");this._promotionCard.show(e)}else{if(!this._promotionPopup)throw new Error("It needs to be added PromotionPopup handler.");this._promotionPopup.show(e)}}click(t){try{const r=t.features&&t.features[0];if(!r)return;const{properties:o}=r,{adid:i}=o;if(!i)return;e.sendSelection(i,this.map.getZoom()),this.fire(new e.Event(e.EVENT_TYPES.CLICK_PIN,{map:t.target,originalEvent:t.originalEvent,feature:r})),this.show(r)}catch(e){console.error(e)}}idle(e){this.map.getLayer(this._layerId)&&this.map.getSource(this._sourceId)||this.reloadPromotionLalyer()}on(e,t){this._listeners[e]&&-1!==this._listeners[e].indexOf(t)||(this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(t))}off(e,t){if(this._listeners&&this._listeners[e]){const r=this._listeners[e].indexOf(t);-1!==r&&this._listeners[e].splice(r,1)}}fire(e){const{type:t,data:r}=e,o=this._listeners&&this._listeners[t]?this._listeners[t].slice():[];for(const e of o)e.call(this,t,r)}selectPin(e){const{adid:t}=e.properties;if(!t)return;const r=((e,t)=>["case",["==",["get","adid"],e],t?l:h,t?s:a])(t),o=((e,t)=>["case",["==",["get","adid"],e],t?m:c,t?n:d])(t);this._map.setPaintProperty(this._layerId,"text-color",r),this._map.setPaintProperty(this._layerId,"text-halo-color",o)}deselectPin(){this._map.setPaintProperty(this._layerId,"text-color",this.isDarkMode?s:a),this._map.setPaintProperty(this._layerId,"text-halo-color",this.isDarkMode?n:d)}async styleImageMissing(t){try{const r=t.id;if(r&&!this._map.hasImage(r)&&r.match(/^([a-zA-Z0-9]{21,22})$/)){const t=(t=>`${e.config.BASE_URL}/ads/v1/campaign/resources/creatives/${t}?access_token=${e.config.ACCESS_TOKEN}`)(r);this._map.loadImage(t,((e,t)=>{if(e)throw e;if(!t)throw new Error("getting image failed.");this._map.addImage(r,t)}))}}catch(e){console.error(e)}}updateRenderedFeatures(){const t=this.promotionFeatures(),r=[];this._renderedFeaturesAdids=this._renderedFeaturesAdids.filter((({adid:e,visibleStartTime:o})=>{const i=!!t.find((t=>e===t.properties.adid));return!!i||(r.push({adid:e,visibleStartTime:o,visibleEndTime:Date.now()}),!1)})),t.forEach((e=>{!!!this._renderedFeaturesAdids.find((({adid:t})=>t===e.properties.adid))&&e.properties.adid&&this._renderedFeaturesAdids.push({adid:e.properties.adid,visibleStartTime:Date.now()})})),r.length&&e.sendVisibilities(r)}addHandler(e){switch(e.initPromoted(this),e.id){case"PromotionPopup":this._promotionPopup=e;break;case"PromotionCard":this._promotionCard=e;break;case"PromotionSideCard":this._promotionSideCard=e}}promotionFeatures(){if(!this.map.getLayer(this._layerId))return[];const e=this.map.queryRenderedFeatures(void 0,{layers:[this._layerId]}),t=[];for(const r of e)r.properties&&r.properties.adid&&t.push(r);return t}showLayer(){this._map.setLayoutProperty(this._layerId,"visibility","none")}hideLayer(){this._map.setLayoutProperty(this._layerId,"visibility","visible")}deselectLayer(){this.deselectPin()}}exports.PromotionPopup=r,exports.PromotionCard=o,exports.PromotionSideCard=i,exports.MapboxPromoted=g,exports.default=g;
